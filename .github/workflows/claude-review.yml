# Claude Ops: Review open PRs via Code Reviewer role
# Triggers reactively when PRs are opened or updated.
# Cron fallback: daily 22:00 catches missed PR events.

name: "Claude: Review PR"

on:
  pull_request:
    types: [opened, synchronize]

concurrency:
  group: claude-dev-review
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: [self-hosted, claude-ops]
    if: >-
      github.event.pull_request.draft == false &&
      github.event.pull_request.head.repo.fork == false
    timeout-minutes: 45
    env:
      CLAUDE_OPS_HOME: /Users/austin/Git_Repos/claude-ops
      HOME: /Users/austin
      PATH: /opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin
    steps:
      - name: Run Code Review
        run: "$CLAUDE_OPS_HOME/jobs/dev-review-prs.sh"
      - name: Notify on failure
        if: failure()
        env:
          WORKFLOW_NAME: ${{ github.workflow }}
        run: |
          echo "::error::Claude job failed: ${WORKFLOW_NAME} on $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "### Failed: Code Review" >> "$GITHUB_STEP_SUMMARY"
          echo "Check workflow run logs for details." >> "$GITHUB_STEP_SUMMARY"
